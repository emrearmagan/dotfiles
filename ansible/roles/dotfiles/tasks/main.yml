---
- name: Ensure dotfiles backup directory exists
  file:
    path: "{{ dotfiles_backup_path }}"
    state: directory

- name: Stat existing dotfiles
  stat:
    path: "{{ item.dest }}"
  loop: "{{ dotfiles }}"
  register: dotfiles_stat
  no_log: false

- name: Backup existing dotfiles if they are not symlinks
  copy:
    src: "{{ item.item.dest }}"
    dest: "{{ dotfiles_backup_path }}/"
    remote_src: true
  when:
    - item.stat.exists
    - not item.stat.islnk
  loop: "{{ dotfiles_stat.results }}"
  loop_control:
    label: "{{ item.item.dest }}"

- name: Remove non-symlink dotfiles
  file:
    path: "{{ item.item.dest }}"
    state: absent
  when:
    - item.stat.exists
    - not item.stat.islnk
  loop: "{{ dotfiles_stat.results }}"
  loop_control:
    label: "{{ item.item.dest }}"
  register: removed_files

- name: Ensure parent directories for dotfile symlinks exist
  file:
    path: "{{ item.dest | dirname }}"
    state: directory
  loop: "{{ dotfiles }}"
  loop_control:
    label: "{{ item.dest }}"

- name: Create symlinks for dotfiles
  file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: link
    force: true
  loop: "{{ dotfiles }}"
